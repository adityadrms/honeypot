#!/bin/bash

# Cowrie Installation and Running Script

# Update system
echo "Updating system..."
sudo apt update -y
sudo apt install iptables -y

# Install dependencies
echo "Installing dependencies..."
sudo apt-get install git python3-virtualenv libssl-dev libffi-dev build-essential libpython3-dev python3-minimal authbind virtualenv

# Create a dedicated user for Cowrie
echo "Creating cowrie user..."
sudo adduser --disabled-password --gecos "" cowrie

# Switch to the cowrie user and set up Cowrie
echo "Setting up Cowrie environment..."
sudo -u cowrie -H bash <<EOF
# Navigate to the home directory
cd ~

# Clone the Cowrie repository
git clone https://github.com/cowrie/cowrie

# Navigate to the Cowrie directory
cd cowrie

# Create virtual environment
python -m venv cowrie-env

# Activate virtual environment and install dependencies
source cowrie-env/bin/activate
python -m pip install --upgrade pip && python -m pip install --upgrade -r requirements.txt


# Copy default configuration
cp etc/cowrie.cfg.dist etc/cowrie.cfg
EOF

# Configure Cowrie to start 
echo "Starting cowrie..."
sudo -u cowrie -H bash <<EOF
source ~/cowrie/cowrie-env/bin/activate
cd ~/cowrie
./bin/cowrie start
EOF

# Configure log
echo "Open log..."
sudo -u cowrie -H bash <<EOF
source ~/cowrie/cowrie-env/bin/activate
cd ~/cowrie/var/log/cowrie
tail -f cowrie.log
EOF

# Display message indicating completion
echo "Cowrie installation and setup complete. Cowrie is now running."
