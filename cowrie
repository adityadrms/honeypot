#!/bin/bash

# Update dan upgrade sistem
sudo apt-get update -y
sudo apt install iptables -y

# Install dependensi dasar
sudo apt-get install -y git python3 python3-venv python3-dev build-essential libssl-dev libffi-dev libpython3-dev libxml2-dev libxslt1-dev zlib1g-dev

# Membuat user cowrie jika belum ada
if id "cowrie" &>/dev/null; then
    echo "User cowrie sudah ada"
else
    sudo useradd -m -d /home/cowrie -s /bin/bash --disabled-password --gecos cowrie
    echo "User cowrie telah dibuat"
fi

# Switch ke user cowrie
sudo -i -u cowrie << 'EOF'

# Set direktori home
cd /home/cowrie

# Clone repository Cowrie
if [ ! -d "cowrie" ]; then
    git clone https://github.com/cowrie/cowrie
else
    echo "Directory cowrie sudah ada"
fi

cd cowrie

# Membuat virtual environment dan mengaktifkannya
if [ ! -d "cowrie-env" ]; then
    python3 -m venv cowrie-env
fi
source cowrie-env/bin/activate

# Menginstall dependensi Cowrie
pip install --upgrade pip
pip install -r requirements.txt

# Menyiapkan konfigurasi Cowrie
cp etc/cowrie.cfg.dist etc/cowrie.cfg

EOF

# Membuat service systemd untuk Cowrie
sudo tee /etc/systemd/system/cowrie.service > /dev/null <<EOT
[Unit]
Description=Cowrie SSH Honeypot
After=network.target

[Service]
User=cowrie
Group=cowrie
WorkingDirectory=/home/cowrie/cowrie
Environment="VIRTUAL_ENV=/home/cowrie/cowrie/cowrie-env"
Environment="PATH=\$VIRTUAL_ENV/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
ExecStart=/home/cowrie/cowrie/cowrie-env/bin/python3 /home/cowrie/cowrie/src/cowrie/main.py
Restart=always

[Install]
WantedBy=multi-user.target
EOT

# Reload systemd dan enable cowrie service
sudo systemctl daemon-reload
sudo systemctl enable cowrie
sudo systemctl start cowrie


