#!/bin/bash


# Step 1: Install system dependencies
sudo apt-get update
sudo apt-get install -y git python3-virtualenv libssl-dev libffi-dev build-essential libpython3-dev python3-minimal authbind
sudo apt-get install -y iptables

# Step 2: Create a dedicated non-root user for Cowrie
sudo adduser --disabled-password --gecos "" cowrie

# Step 3: Switch to the cowrie user
sudo su - cowrie << 'EOF'

# Step 4: Checkout the Cowrie code
sudo git clone http://github.com/cowrie/cowrie
cd cowrie

# Step 5: Setup the Python virtual environment
python3 -m venv cowrie-env
source cowrie-env/bin/activate

# Upgrade pip and install the required Python packages
pip install --upgrade pip
pip install --upgrade -r requirements.txt

# Step 6: Install configuration file
cp etc/cowrie.cfg.dist etc/cowrie.cfg

# Step 7: Starting Cowrie (initial run to check setup)
bin/cowrie start
bin/cowrie stop

EOF

# Allow the cowrie user to bind to port 22 using authbind
sudo touch /etc/authbind/byport/22
sudo chown cowrie:cowrie /etc/authbind/byport/22
sudo chmod 770 /etc/authbind/byport/22


# Step 8: Setup systemd service to start Cowrie automatically
sudo tee /etc/systemd/system/cowrie.service > /dev/null << EOL

