 #!/bin/bash

# Cowrie Installation and Running Script

# Update & Install System
echo "Updating system..."
sudo apt update -y
sudo apt install iptables -y
sudo apt install authbind -y

# Install dependencies
echo "Installing dependencies..."
sudo apt install -y git python3-venv libssl-dev libffi-dev build-essential libpython3-dev python3-minimal authbind

# Create user Cowrie
echo "Creating cowrie user..."
sudo adduser --disabled-password --gecos "" cowrie

# Switch and set up to user cowrie
echo "Setting up Cowrie environment..."
sudo -u cowrie git clone https://github.com/cowrie/cowrie /home/cowrie/cowrie
cd /home/cowrie/cowrie

# Create virtual environment and install dependencies
sudo -u cowrie /bin/bash << 'EOF'
python3 -m venv cowrie-env
source cowrie-env/bin/activate
python -m pip install --upgrade pip
python -m pip install --upgrade -r requirements.txt
cp etc/cowrie.cfg.dist etc/cowrie.cfg
EOF

# Start Cowrie
echo "Starting Cowrie..."
sudo -u cowrie /bin/bash << 'EOF'
source cowrie-env/bin/activate
bin/cowrie start
EOF

# Redirect Port
sudo su /bin/bash << 'EOF'
cd /home/raspberry
sudo iptables -t nat -A PREROUTING -p tcp --dport 22 -j REDIRECT --to-port 2222
sudo iptables -t nat -A PREROUTING -p tcp --dport 23 -j REDIRECT --to-port 2223
sudo touch /etc/authbind/byport/22
sudo chown cowrie:cowrie /etc/authbind/byport/22
sudo chmod 770 /etc/authbind/byport/22
EOF

# Open Log
echo "Try to open Log..."
sudo -u cowrie /bin/bash << 'EOF'
source cowrie-env/bin/activate
cd /home/cowrie/cowrie/var/log/cowrie
tail -f cowrie.log
EOF



